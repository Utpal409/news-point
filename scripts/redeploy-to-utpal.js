require('dotenv').config({ path: '.env.local' });
const oracledb = require('oracledb');
const path = require('path');

try {
    oracledb.initOracleClient({ configDir: path.resolve(process.cwd(), 'oracle_wallet') });
} catch (err) { }

async function redeployToUtpal() {
    const adminConfig = {
        user: 'ADMIN',
        password: process.env.ORACLE_DB_PASSWORD,
        connectString: 'm2_high'
    };

    let connection;
    try {
        connection = await oracledb.getConnection(adminConfig);
        try { await connection.execute(`DROP TABLE UTPAL.NEWS_ARTICLES CASCADE CONSTRAINTS`); } catch (e) { }
        try { await connection.execute(`DROP TABLE UTPAL.NEWS_AUTHORS CASCADE CONSTRAINTS`); } catch (e) { }

        await connection.execute(`
      CREATE TABLE UTPAL.NEWS_AUTHORS (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name VARCHAR2(100) NOT NULL,
        role VARCHAR2(50) DEFAULT 'Editor',
        avatar_url VARCHAR2(255),
        bio VARCHAR2(1000)
      )
    `);

        await connection.execute(`
      CREATE TABLE UTPAL.NEWS_ARTICLES (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        slug VARCHAR2(200) NOT NULL UNIQUE,
        title VARCHAR2(300) NOT NULL,
        subtitle VARCHAR2(500),
        content CLOB NOT NULL,
        category VARCHAR2(50) NOT NULL,
        image_url VARCHAR2(500),
        author_id NUMBER,
        published_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_utpal_author FOREIGN KEY (author_id) REFERENCES UTPAL.NEWS_AUTHORS(id)
      )
    `);

        await connection.execute(`INSERT INTO UTPAL.NEWS_AUTHORS (name, role) VALUES ('Utpal', 'Site Owner')`);
        await connection.execute(`
      INSERT INTO UTPAL.NEWS_ARTICLES (slug, title, content, category, image_url, author_id) 
      VALUES ('spacex', 'SpaceX Mission Success', 'Starship has successfully reached orbit.', 'Space', 'https://images.unsplash.com/photo-1517976487492-5750f3195933', 1)
    `);
        await connection.commit();
        console.log('✨ SUCCESS! All data is now inside the UTPAL schema.');
    } catch (err) {
        console.error('❌ Failed:', err);
    } finally {
        if (connection) await connection.close();
    }
}

redeployToUtpal();
