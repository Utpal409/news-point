require('dotenv').config({ path: '.env.local' });
const oracledb = require('oracledb');
const path = require('path');

try { oracledb.initOracleClient({ configDir: path.resolve(process.cwd(), 'oracle_wallet') }); } catch (err) { }

async function migrateCategories() {
    const adminConfig = {
        user: 'ADMIN',
        password: process.env.ORACLE_DB_PASSWORD || 'Utpal@1234567',
        connectString: 'm2_high'
    };

    let connection;
    try {
        console.log('üîå Connecting as ADMIN...');
        connection = await oracledb.getConnection(adminConfig);
        console.log('‚úÖ Connected.');

        try { await connection.execute(`DROP TABLE UTPAL.NEWS_ARTICLES CASCADE CONSTRAINTS`); } catch (e) { }
        try { await connection.execute(`DROP TABLE UTPAL.NEWS_CATEGORIES CASCADE CONSTRAINTS`); } catch (e) { }
        try { await connection.execute(`DROP TABLE UTPAL.NEWS_AUTHORS CASCADE CONSTRAINTS`); } catch (e) { }

        await connection.execute(`
            CREATE TABLE UTPAL.NEWS_AUTHORS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                name VARCHAR2(100) NOT NULL,
                role VARCHAR2(50) DEFAULT 'Editor'
            )
        `);

        await connection.execute(`
            CREATE TABLE UTPAL.NEWS_CATEGORIES (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                slug VARCHAR2(50) NOT NULL UNIQUE,
                name_en VARCHAR2(100) NOT NULL,
                name_hi NVARCHAR2(100) NOT NULL
            )
        `);

        await connection.execute(`
            CREATE TABLE UTPAL.NEWS_ARTICLES (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                slug VARCHAR2(200) NOT NULL UNIQUE,
                title VARCHAR2(300) NOT NULL,
                subtitle VARCHAR2(500),
                content CLOB NOT NULL,
                category_id NUMBER,
                image_url VARCHAR2(500),
                author_id NUMBER,
                published_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                tags VARCHAR2(500),
                CONSTRAINT fk_article_category FOREIGN KEY (category_id) REFERENCES UTPAL.NEWS_CATEGORIES(id),
                CONSTRAINT fk_article_author FOREIGN KEY (author_id) REFERENCES UTPAL.NEWS_AUTHORS(id)
            )
        `);

        console.log('üå± Seeding Data...');
        const categories = [
            { slug: 'space', en: 'Space', hi: '‡§Ö‡§Ç‡§§‡§∞‡§ø‡§ï‡•ç‡§∑' },
            { slug: 'tech', en: 'Technology', hi: '‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä' },
            { slug: 'world', en: 'World', hi: '‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ' },
            { slug: 'business', en: 'Business', hi: '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞' },
            { slug: 'opinion', en: 'Opinion', hi: '‡§µ‡§ø‡§ö‡§æ‡§∞' },
            { slug: 'life', en: 'Lifestyle', hi: '‡§ú‡•Ä‡§µ‡§®‡§∂‡•à‡§≤‡•Ä' },
            { slug: 'culture', en: 'Culture', hi: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø' }
        ];

        for (const cat of categories) {
            await connection.execute(
                `INSERT INTO UTPAL.NEWS_CATEGORIES (slug, name_en, name_hi) VALUES (:1, :2, :3)`,
                [cat.slug, cat.en, cat.hi]
            );
        }

        await connection.execute(`INSERT INTO UTPAL.NEWS_AUTHORS (name, role) VALUES ('Utpal', 'Editor-in-Chief')`);

        await connection.execute(`
            INSERT INTO UTPAL.NEWS_ARTICLES (slug, title, content, category_id, image_url, author_id, tags) 
            VALUES ('spacex-success', 'SpaceX Mission Success', 'Starship has successfully reached orbit.', 1, 'https://images.unsplash.com/photo-1517976487492-5750f3195933', 1, 'Space,ElonMusk')
        `);

        await connection.execute(`
            INSERT INTO UTPAL.NEWS_ARTICLES (slug, title, content, category_id, image_url, author_id, tags) 
            VALUES ('ai-breakthrough', 'AI Breakthrough 2026', 'Neural networks have achieved a new milestone in weather prediction.', 2, 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485', 1, 'AI,Tech,Future')
        `);

        await connection.commit();

        await connection.execute(`
            CREATE OR REPLACE VIEW UTPAL.NEWS_ARTICLES_V AS
            SELECT 
                a.id, a.slug, a.title, a.subtitle, a.content, a.image_url, a.published_at, a.tags,
                c.name_en as category_name, c.name_hi as category_name_hi, c.slug as category_slug
            FROM UTPAL.NEWS_ARTICLES a
            JOIN UTPAL.NEWS_CATEGORIES c ON a.category_id = c.id
        `);

        const objectsToEnable = [
            { name: 'NEWS_CATEGORIES', type: 'TABLE' },
            { name: 'NEWS_ARTICLES', type: 'TABLE' },
            { name: 'NEWS_AUTHORS', type: 'TABLE' },
            { name: 'NEWS_ARTICLES_V', type: 'VIEW' }
        ];

        for (const obj of objectsToEnable) {
            try {
                await connection.execute(`
                    BEGIN
                      ORDS.ENABLE_OBJECT(
                        exists_check => TRUE,
                        schema => 'UTPAL',
                        object => '${obj.name}',
                        object_type => '${obj.type}',
                        object_alias => '${obj.name.toLowerCase()}',
                        auto_rest_auth => FALSE
                      );
                      COMMIT;
                    END;
                `);
            } catch (e) { }
        }

    } catch (err) {
        console.error('‚ùå Failed:', err);
    } finally {
        if (connection) await connection.close();
    }
}

migrateCategories();
