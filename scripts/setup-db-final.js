const oracledb = require('oracledb');
const path = require('path');

oracledb.initOracleClient({ libDir: undefined });

const dbConfig = {
    user: 'UTPAL',
    password: 'Abhishekkumar007#!',
    connectString: 'm2_high'
};

async function setupDatabase() {
    let connection;
    try {
        connection = await oracledb.getConnection(dbConfig);
        try { await connection.execute(`DROP TABLE NEWS_ARTICLES CASCADE CONSTRAINTS`); } catch (e) { }
        try { await connection.execute(`DROP TABLE NEWS_AUTHORS CASCADE CONSTRAINTS`); } catch (e) { }

        await connection.execute(`CREATE TABLE NEWS_AUTHORS (id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, name VARCHAR2(100) NOT NULL)`);
        await connection.execute(`CREATE TABLE NEWS_ARTICLES (id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, slug VARCHAR2(200) NOT NULL UNIQUE, title VARCHAR2(300) NOT NULL, subtitle VARCHAR2(500), content CLOB NOT NULL, category VARCHAR2(50) NOT NULL, image_url VARCHAR2(500), author_id NUMBER)`);

        await connection.execute(`INSERT INTO NEWS_AUTHORS (name) VALUES ('Utpal')`);
        await connection.commit();

        const articles = [
            { slug: 'spacex', title: 'SpaceX Mission Success', content: 'Starship reached orbit today.', category: 'Space', image: 'https://images.unsplash.com/photo-1517976487492-5750f3195933' },
            { slug: 'ai-news', title: 'AI Breakthrough', content: 'Neural nets predict weather.', category: 'Tech', image: 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485' }
        ];

        for (const art of articles) {
            await connection.execute(`INSERT INTO NEWS_ARTICLES (slug, title, content, category, image_url, author_id) VALUES (:1, :2, :3, :4, :5, 1)`, [art.slug, art.title, art.content, art.category, art.image]);
        }

        await connection.commit();
        console.log('✅ UTPAL SCHEMA IS READY!');
    } catch (err) {
        console.error('❌ Failed:', err);
    } finally {
        if (connection) await connection.close();
    }
}

setupDatabase();
